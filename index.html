<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesas Millonarias - Panel de Control</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0d1a26;
            color: #ecf0f1;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .contenedor-configuracion {
            background-color: rgba(31, 50, 70, 0.9);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            max-width: 700px;
            width: 100%;
            border: 2px solid #34495e;
            margin-bottom: 20px;
        }
        h3, h4 {
            color: #f39c12;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
            text-align: center;
        }
        h3 { font-size: 1.8em; margin: 0 0 20px; }
        h4 { margin: 20px 0 10px; border-top: 1px solid #4a627d; padding-top: 20px; }
        h5 { margin: 15px 0 10px; }

        .config-seccion, .control-seccion {
            margin-bottom: 20px;
            border-bottom: 1.5px solid #4a627d;
            padding-bottom: 15px;
        }
        .config-seccion:last-of-type { border-bottom: none; }
        
        /* Estilos de la sección de control */
        .control-seccion {
            background-color: rgba(13, 26, 38, 0.7);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #34495e;
        }
        .control-botones {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        #status-pantalla {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        #status-pantalla.conectado { background-color: #27ae60; color: white; }
        #status-pantalla.desconectado { background-color: #c0392b; color: white; }

        .btn {
            background-color: #2c3e50; color: white; padding: 10px 15px;
            border: none; border-radius: 5px; cursor: pointer;
            transition: background-color 0.2s; font-weight: bold;
        }
        .btn:hover:not(:disabled) { background-color: #34495e; }
        .btn:disabled { background-color: #555; cursor: not-allowed; opacity: 0.6; }

        /* NUEVO: Estilo para el botón de iniciar sorteo */
        #btn-iniciar-sorteo {
            background-color: #27ae60;
        }
        #btn-iniciar-sorteo:hover:not(:disabled) {
            background-color: #2ecc71;
        }

        #btn-premio {
            font-size: 1.8em;
            padding: 5px 12px;
            background-color: #e67e22;
        }
        #btn-premio:hover:not(:disabled) { background-color: #d35400; }

        /* Estilos de la configuración (listas, inputs) */
        .lista-opciones { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; list-style: none; padding: 0; margin: 0; }
        .lista-opciones label { background-color: #34495e; padding: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; text-align: left; display: flex; align-items: center; box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); }
        .lista-opciones label:hover { background-color: #4a627d; }
        .lista-opciones input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
        .lista-opciones li { position: relative; }
        .lista-opciones li .btn-eliminar { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px; font-size: 1.2em; background: none; color: #e74c3c; border: none; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .lista-opciones li:hover .btn-eliminar { opacity: 1; }
        .input-group { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
        .input-group input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #4a627d; background-color: #1f3246; color: #ecf0f1; }
        .input-group input[type="color"] { min-width: 40px; height: 40px; padding: 2px; border-radius: 5px; border: 1px solid #4a627d; background-color: #1f3246; cursor: pointer; }
        .botones-opciones { display: flex; gap: 10px; margin-bottom: 10px; justify-content: flex-start; }
        .btn-opcion { font-size: 0.9em; padding: 5px 10px; background-color: #555; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-guardar { background-color: #3498db; width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2em; }
        .btn-guardar:hover { background-color: #2980b9; }
    </style>
</head>
<body>
    <div class="contenedor-configuracion">
        <h3>Panel de Control</h3>

        <div class="control-seccion">
            <h4>Control de Pantalla de Sorteo</h4>
            <div class="control-botones">
                <button id="btn-lanzar-pantalla" class="btn">Lanzar Pantalla</button>
                <!-- NUEVO: Botón para iniciar el sorteo remotamente -->
                <button id="btn-iniciar-sorteo" class="btn" title="Iniciar Sorteo" disabled>▶️ Iniciar Sorteo</button>
                <button id="btn-premio" class="btn" title="Entregar Premio" disabled>🎉</button>
                <span id="status-pantalla" class="desconectado">Desconectado</span>
            </div>
             <p style="font-size: 0.8em; text-align: center; opacity: 0.7; margin-top: 10px;">
                <strong>Nota:</strong> Si la pantalla no aparece, revisa que tu navegador no esté bloqueando las ventanas emergentes.
            </p>
        </div>

        <!-- El resto del HTML de configuración no cambia -->
        <div class="config-seccion">
            <h4>Mesas en juego:</h4>
            <div class="botones-opciones">
                <button class="btn-opcion" onclick="toggleCheckboxes('mesas-en-juego', true)">Seleccionar todos</button>
                <button class="btn-opcion" onclick="toggleCheckboxes('mesas-en-juego', false)">Desmarcar todos</button>
            </div>
            <ul class="lista-opciones" id="lista-mesas-juego"></ul>
            <div class="input-group">
                <input type="text" id="nueva-mesa-input" placeholder="Nombre de la nueva mesa">
                <button class="btn btn-agregar" id="btn-agregar-mesa">Agregar</button>
            </div>
        </div>
        <div class="config-seccion">
            <h4>Colores de Ruletas:</h4>
             <h5>Ruleta 21, 24 y 25:</h5>
                <div class="botones-opciones">
                    <button class="btn-opcion" onclick="toggleCheckboxes('colores-ruleta-21', true)">Seleccionar todos</button>
                    <button class="btn-opcion" onclick="toggleCheckboxes('colores-ruleta-21', false)">Desmarcar todos</button>
                </div>
                <ul class="lista-opciones" id="lista-colores-21"></ul>
                <div class="input-group">
                    <input type="text" id="nuevo-color-nombre-21-input" placeholder="Nombre del color">
                    <input type="color" id="nuevo-color-hex-21-input" value="#e66465">
                    <button class="btn btn-agregar" id="btn-agregar-color-21">Agregar</button>
                </div>
                <h5>Ruleta 22 y 23 (Comparten colores):</h5>
                 <div class="botones-opciones">
                    <button class="btn-opcion" onclick="toggleCheckboxes('colores-ruleta-22-23', true)">Seleccionar todos</button>
                    <button class="btn-opcion" onclick="toggleCheckboxes('colores-ruleta-22-23', false)">Desmarcar todos</button>
                </div>
                <ul class="lista-opciones" id="lista-colores-22-23"></ul>
                <div class="input-group">
                    <input type="text" id="nuevo-color-nombre-22-23-input" placeholder="Nombre del color">
                    <input type="color" id="nuevo-color-hex-22-23-input" value="#f6b73c">
                    <button class="btn btn-agregar" id="btn-agregar-color-22-23">Agregar</button>
                </div>
        </div>
        <button id="btn-guardar" class="btn btn-guardar">Guardar y Sincronizar</button>
    </div>

    <script>
        let sorteoWindow = null;
        const btnLanzar = document.getElementById('btn-lanzar-pantalla');
        const btnPremio = document.getElementById('btn-premio');
        const statusPantalla = document.getElementById('status-pantalla');
        // NUEVO: Referencia al nuevo botón
        const btnIniciarSorteo = document.getElementById('btn-iniciar-sorteo');

        const defaultData = {
            mesas: [ 'Blackjack 17', 'Blackjack 15', 'Blackjack 34', 'Draw-Poker 7', 'Draw-Poker 12', 'Hold\'em-Poker 8', 'Caribbean-Poker 13', 'Ruleta 21', 'Ruleta 22', 'Ruleta 23', 'Ruleta 24', 'Ruleta 25' ],
            colores21: ['Lila', 'Amarillo', 'Rojo', 'Verde', 'Azul', 'Plomo', 'Naranjo', 'Burdeo'],
            colores22_23: ['Amarillo', 'Verde', 'Azul', 'Celeste', 'Café', 'Negro', 'Burdeo', 'Rojo', 'Naranjo', 'Calipso', 'Gris'],
            colorMap: { 'lila': '#9B59B6', 'amarillo': '#F1C40F', 'rojo': '#E74C3C', 'verde': '#2ECC71', 'azul': '#3498DB', 'plomo': '#95A5A6', 'naranjo': '#E67E22', 'burdeo': '#C0392B', 'celeste': '#5DADE2', 'cafe': '#A0522D', 'negro': '#000000', 'calipso': '#00A896', 'gris': '#7f8c8d', 'blanco': '#FFFFFF', 'marron': '#8B4513', 'morado': '#8E44AD' }
        };

        let todasLasMesas, coloresRuleta21, coloresRuleta22_23, colorMap;

        function lanzarPantallaSorteo() {
            if (sorteoWindow && !sorteoWindow.closed) {
                sorteoWindow.focus();
                return;
            }
            sorteoWindow = window.open('sorteo.html', 'Sorteo', 'fullscreen=yes,menubar=no,toolbar=no,location=no,status=no');
             if (!sorteoWindow) {
                alert("El navegador bloqueó la ventana emergente.");
                return;
            }
            actualizarStatusPantalla();
        }

        function actualizarStatusPantalla() {
            if (sorteoWindow && !sorteoWindow.closed) {
                statusPantalla.textContent = 'Conectado';
                statusPantalla.className = 'conectado';
                btnLanzar.textContent = 'Enfocar Pantalla';
                // NUEVO: Habilitar el botón de iniciar sorteo cuando está conectado
                btnIniciarSorteo.disabled = false;
            } else {
                statusPantalla.textContent = 'Desconectado';
                statusPantalla.className = 'desconectado';
                btnLanzar.textContent = 'Lanzar Pantalla';
                btnPremio.disabled = true;
                // NUEVO: Deshabilitar también el botón de iniciar
                btnIniciarSorteo.disabled = true;
                sorteoWindow = null;
            }
        }
        
        window.sorteoTerminado = function() {
            btnPremio.disabled = false;
            // NUEVO: Re-habilitar el botón de iniciar para el próximo sorteo
            btnIniciarSorteo.disabled = false;
        }

        function entregarPremio() {
            if (sorteoWindow && !sorteoWindow.closed) {
                sorteoWindow.entregarPremio();
                btnPremio.disabled = true;
            } else {
                alert('La pantalla de sorteo no está abierta.');
            }
        }

        // NUEVO: Función para iniciar el sorteo desde el panel
        function iniciarSorteoRemoto() {
            if (sorteoWindow && !sorteoWindow.closed) {
                sorteoWindow.iniciarSorteoRemoto(); // Llama a la nueva función en sorteo.html
                // Deshabilitar botones mientras el sorteo está en curso
                btnPremio.disabled = true;
                btnIniciarSorteo.disabled = true;
            } else {
                alert('La pantalla de sorteo no está abierta.');
            }
        }

        setInterval(actualizarStatusPantalla, 1000);

        // --- El resto del JS de configuración no cambia ---
        const guardarDatos = () => { /* ...código sin cambios... */ const data = { mesas: todasLasMesas, colores21: coloresRuleta21, colores22: coloresRuleta22_23, colores23: coloresRuleta22_23, colorMap: colorMap, checkedMesas: Array.from(document.querySelectorAll('input[name="mesas-en-juego"]:checked')).map(cb => cb.value), checkedColores21: Array.from(document.querySelectorAll('input[name="colores-ruleta-21"]:checked')).map(cb => cb.value), checkedColores22: Array.from(document.querySelectorAll('input[name="colores-ruleta-22-23"]:checked')).map(cb => cb.value), checkedColores23: Array.from(document.querySelectorAll('input[name="colores-ruleta-22-23"]:checked')).map(cb => cb.value), }; localStorage.setItem('mesasMillonariasData', JSON.stringify(data)); if (sorteoWindow && !sorteoWindow.closed) { sorteoWindow.location.reload(); } alert('¡Configuración guardada y sincronizada!'); };
        const cargarDatos = () => { /* ...código sin cambios... */ const storedData = localStorage.getItem('mesasMillonariasData'); const data = storedData ? JSON.parse(storedData) : defaultData; todasLasMesas = data.mesas || defaultData.mesas; coloresRuleta21 = data.colores21 || defaultData.colores21; coloresRuleta22_23 = data.colores22_23 || data.colores22 || defaultData.colores22_23; colorMap = data.colorMap || defaultData.colorMap; };
        const aplicarSeleccionesGuardadas = () => { /* ...código sin cambios... */ const storedData = localStorage.getItem('mesasMillonariasData'); document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); if (storedData) { const data = JSON.parse(storedData); (data.checkedMesas || []).forEach(val => { const cb = document.querySelector(`input[name="mesas-en-juego"][value="${val}"]`); if (cb) cb.checked = true; }); (data.checkedColores21 || []).forEach(val => { const cb = document.querySelector(`input[name="colores-ruleta-21"][value="${val}"]`); if (cb) cb.checked = true; }); const colores22_23_checked = data.checkedColores22 || data.checkedColores23 || []; colores22_23_checked.forEach(val => { const cb = document.querySelector(`input[name="colores-ruleta-22-23"][value="${val}"]`); if (cb) cb.checked = true; }); } else { document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true); } };
        const formatColorName = (name) => { if (typeof name !== 'string') return ''; return name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-'); };
        const crearCheckbox = (name, value) => { const li = document.createElement('li'); const label = document.createElement('label'); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.name = name; checkbox.value = value; label.textContent = value; if (name.includes('colores')) { const hexColor = colorMap[formatColorName(value)] || '#ECF0F1'; label.style.color = hexColor; label.style.textShadow = '0 0 3px rgba(0,0,0,0.7)'; } const btnEliminar = document.createElement('button'); btnEliminar.className = 'btn-eliminar'; btnEliminar.innerHTML = '&#x2715;'; btnEliminar.title = `Eliminar "${value}"`; btnEliminar.onclick = (e) => { e.stopPropagation(); e.preventDefault(); eliminarOpcion(name, value); }; label.prepend(checkbox); li.appendChild(label); li.appendChild(btnEliminar); return li; };
        const generarSelectores = (listId, dataArray, checkboxName) => {  const listaElement = document.getElementById(listId);  listaElement.innerHTML = '';  dataArray.forEach(item => listaElement.appendChild(crearCheckbox(checkboxName, item)));  };
        const toggleCheckboxes = (name, checked) => { document.querySelectorAll(`input[name="${name}"]`).forEach(cb => { cb.checked = checked; }); };
        const eliminarOpcion = (name, value) => { if (!confirm(`¿Estás seguro de que quieres eliminar "${value}" permanentemente?`)) return; if (name === 'mesas-en-juego') { todasLasMesas = todasLasMesas.filter(m => m !== value); generarSelectores('lista-mesas-juego', todasLasMesas, name); } else if (name === 'colores-ruleta-21') { coloresRuleta21 = coloresRuleta21.filter(c => c !== value); generarSelectores('lista-colores-21', coloresRuleta21, name); } else if (name === 'colores-ruleta-22-23') { coloresRuleta22_23 = coloresRuleta22_23.filter(c => c !== value); generarSelectores('lista-colores-22-23', coloresRuleta22_23, name); } };
        const agregarOpcion = (listId, checkboxName, nombreInputId, hexInputId) => { const nombreInputElement = document.getElementById(nombreInputId); const newValue = nombreInputElement.value.trim(); if (!newValue) { alert('Por favor, ingresa un valor.'); return; } const formattedValue = newValue.charAt(0).toUpperCase() + newValue.slice(1); let arrayToUpdate; if (checkboxName === 'mesas-en-juego') arrayToUpdate = todasLasMesas; else if (checkboxName === 'colores-ruleta-21') arrayToUpdate = coloresRuleta21; else if (checkboxName === 'colores-ruleta-22-23') arrayToUpdate = coloresRuleta22_23; if (arrayToUpdate.find(item => item.toLowerCase() === formattedValue.toLowerCase())) { alert(`"${formattedValue}" ya existe.`); return; } if (hexInputId) { const hexValue = document.getElementById(hexInputId).value; colorMap[formatColorName(formattedValue)] = hexValue; } arrayToUpdate.push(formattedValue); generarSelectores(listId, arrayToUpdate, checkboxName); nombreInputElement.value = ''; };

        // --- Event Listeners ---
        btnLanzar.addEventListener('click', lanzarPantallaSorteo);
        btnPremio.addEventListener('click', entregarPremio);
        // NUEVO: Listener para el botón de iniciar sorteo
        btnIniciarSorteo.addEventListener('click', iniciarSorteoRemoto);
        document.getElementById('btn-guardar').addEventListener('click', guardarDatos);
        document.getElementById('btn-agregar-mesa').addEventListener('click', () => agregarOpcion('lista-mesas-juego', 'mesas-en-juego', 'nueva-mesa-input'));
        document.getElementById('btn-agregar-color-21').addEventListener('click', () => agregarOpcion('lista-colores-21', 'colores-ruleta-21', 'nuevo-color-nombre-21-input', 'nuevo-color-hex-21-input'));
        document.getElementById('btn-agregar-color-22-23').addEventListener('click', () => agregarOpcion('lista-colores-22-23', 'colores-ruleta-22-23', 'nuevo-color-nombre-22-23-input', 'nuevo-color-hex-22-23-input'));
        
        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            generarSelectores('lista-mesas-juego', todasLasMesas, 'mesas-en-juego');
            generarSelectores('lista-colores-21', coloresRuleta21, 'colores-ruleta-21');
            generarSelectores('lista-colores-22-23', coloresRuleta22_23, 'colores-ruleta-22-23');
            aplicarSeleccionesGuardadas();
            actualizarStatusPantalla();
        });
    </script>
</body>
</html>


